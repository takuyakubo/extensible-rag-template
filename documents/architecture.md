# 拡張性高いRAGシステム - アーキテクチャ設計書

## 1. アーキテクチャ概要

### 1.1 システム全体像

このアーキテクチャは、拡張性の高いRetrieval Augmented Generation (RAG)システムの設計を定義します。システムは以下の主要コンポーネントから構成されます：

```
                                  ┌─────────────────┐
                                  │                 │
                                  │   クライアント   │
                                  │   (Next.js)     │
                                  │                 │
                                  └────────┬────────┘
                                           │
                                           ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │  認証サービス   │◄──►│   APIゲートウェイ  │◄──►│  ユーザー管理サービス │   │
│  │                │    │   (FastAPI)     │    │                     │   │
│  └────────────────┘    └────────┬────────┘    └─────────────────────┘   │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │ ドキュメント管理  │◄──►│   RAGエンジン    │◄──►│     LLMサービス    │   │
│  │  サービス       │    │                 │    │                     │   │
│  │                │    └────────┬────────┘    └─────────────────────┘   │
│  └───────┬────────┘             │                                        │
│          │                      │                                        │
│          ▼                      ▼                                        │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │    S3ストレージ  │    │ ベクトルデータベース │    │    データベース    │   │
│  │                │    │ (Elasticsearch)  │    │   (PostgreSQL)     │   │
│  └────────────────┘    └─────────────────┘    └─────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 1.2 マイクロサービスアーキテクチャ

システムは疎結合なマイクロサービスアーキテクチャを採用し、各サービスが特定の機能を担当します。これにより、独立したスケーリングと開発が可能になります。

**主要サービス:**
1. **APIゲートウェイサービス** - システムへの単一エントリーポイント
2. **認証サービス** - ユーザー認証と認可を管理
3. **ユーザー管理サービス** - ユーザープロファイルとロール管理
4. **ドキュメント管理サービス** - ドキュメントのアップロード、処理、格納
5. **RAGエンジンサービス** - 検索とLLM生成を統合
6. **LLMサービス** - 複数のLLMプロバイダーへの統一インターフェース

各サービスは独自のデータストアを持ち、必要に応じて他のサービスとAPIを通じて通信します。

## 2. コンポーネント詳細設計

### 2.1 フロントエンド（Next.js）

フロントエンドアプリケーションは、Next.jsフレームワークを使用したSPA（Single Page Application）として実装されます。

**主要コンポーネント:**
1. **チャットインターフェース** - ユーザーとRAGシステムのインタラクション
2. **ドキュメント管理ダッシュボード** - ドキュメントのアップロードと管理
3. **管理コンソール** - システム設定と監視
4. **ユーザー管理インターフェース** - ユーザーとロールの管理

**技術スタック:**
- Next.js 14+（App Routerアーキテクチャ）
- React 18+
- TailwindCSS（スタイリング）
- Zustand（状態管理）
- React Query（APIデータフェッチング）
- Shadcn UI（UIコンポーネントライブラリ）

**フロントエンドディレクトリ構造:**
```
frontend/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   └── register/
│   ├── (dashboard)/
│   │   ├── admin/
│   │   ├── documents/
│   │   └── settings/
│   ├── chat/
│   └── layout.tsx
├── components/
│   ├── ui/
│   ├── chat/
│   ├── documents/
│   └── admin/
├── lib/
│   ├── api/
│   ├── auth/
│   └── utils/
├── hooks/
├── providers/
└── public/
```

### 2.2 APIゲートウェイ（FastAPI）

APIゲートウェイは、すべてのクライアントリクエストの単一エントリポイントとして機能し、適切なマイクロサービスにルーティングします。

**主要機能:**
1. リクエストのルーティング
2. 認証と認可の検証
3. レート制限
4. リクエスト/レスポンスの変換
5. API文書化（Swagger/OpenAPI）

**エンドポイント:**
- `/api/auth/*` - 認証関連エンドポイント
- `/api/users/*` - ユーザー管理エンドポイント
- `/api/documents/*` - ドキュメント管理エンドポイント
- `/api/chat/*` - チャットと質問応答エンドポイント
- `/api/admin/*` - 管理者用エンドポイント

**技術スタック:**
- FastAPI
- Pydantic（データバリデーション）
- JWT（認証）
- Redis（キャッシュ、レート制限）
