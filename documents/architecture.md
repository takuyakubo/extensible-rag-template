# 拡張性高いRAGシステム - アーキテクチャ設計書

## 目次

1. [アーキテクチャ概要](architecture.md)
2. [コンポーネント詳細設計](architecture/components.md)
3. [システム連携](architecture/integration.md)
4. [拡張アーキテクチャ](architecture/extension.md)
5. [セキュリティアーキテクチャ](architecture/security.md)
6. [運用アーキテクチャ](architecture/operations.md)
7. [実装計画](architecture/implementation.md)
8. [アーキテクチャの決定理由](architecture/rationale.md)

## 1. アーキテクチャ概要

### 1.1 システム全体像

このアーキテクチャは、拡張性の高いRetrieval Augmented Generation (RAG)システムの設計を定義します。システムは以下の主要コンポーネントから構成されます：

```
                                  ┌─────────────────┐
                                  │                 │
                                  │   クライアント   │
                                  │   (Next.js)     │
                                  │                 │
                                  └────────┬────────┘
                                           │
                                           ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │  認証サービス   │◄──►│   APIゲートウェイ  │◄──►│  ユーザー管理サービス │   │
│  │                │    │   (FastAPI)     │    │                     │   │
│  └────────────────┘    └────────┬────────┘    └─────────────────────┘   │
│                                  │                                       │
│                                  ▼                                       │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │ ドキュメント管理  │◄──►│   RAGエンジン    │◄──►│     LLMサービス    │   │
│  │  サービス       │    │                 │    │                     │   │
│  │                │    └────────┬────────┘    └─────────────────────┘   │
│  └───────┬────────┘             │                                        │
│          │                      │                                        │
│          ▼                      ▼                                        │
│  ┌────────────────┐    ┌─────────────────┐    ┌─────────────────────┐   │
│  │                │    │                 │    │                     │   │
│  │    S3ストレージ  │    │ ベクトルデータベース │    │    データベース    │   │
│  │                │    │ (Elasticsearch)  │    │   (PostgreSQL)     │   │
│  └────────────────┘    └─────────────────┘    └─────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 1.2 マイクロサービスアーキテクチャ

システムは疎結合なマイクロサービスアーキテクチャを採用し、各サービスが特定の機能を担当します。これにより、独立したスケーリングと開発が可能になります。

**主要サービス:**
1. **APIゲートウェイサービス** - システムへの単一エントリーポイント
2. **認証サービス** - ユーザー認証と認可を管理
3. **ユーザー管理サービス** - ユーザープロファイルとロール管理
4. **ドキュメント管理サービス** - ドキュメントのアップロード、処理、格納
5. **RAGエンジンサービス** - 検索とLLM生成を統合
6. **LLMサービス** - 複数のLLMプロバイダーへの統一インターフェース

各サービスは独自のデータストアを持ち、必要に応じて他のサービスとAPIを通じて通信します。

### 1.3 データストレージ

システムは複数のデータストアを使用します：

1. **PostgreSQL**
   - ユーザーデータ
   - ドキュメントメタデータ
   - システム設定
   - 会話履歴

2. **Elasticsearch**
   - ベクトル検索（kNN）
   - テキストインデックス
   - セマンティック検索

3. **Amazon S3**
   - 原本ドキュメントストレージ
   - 処理済みテキスト保存

4. **Redis**
   - キャッシュ
   - 一時データ
   - タスクキュー
   - セッション管理
