# システム連携

## 3.1 サービス間通信

サービス間通信は、RESTful APIとイベント駆動型アーキテクチャを組み合わせて実装します：

**同期通信 (REST API):**
- クライアントとAPIゲートウェイ間
- 即時レスポンスが必要な機能

**非同期通信 (イベント):**
- 長時間実行処理（ドキュメント処理など）
- システム内通知

イベントベースの通信には、Redis Pub/Subまたはメッセージブローカー（RabbitMQ、Kafkaなど）を使用します。

## 3.2 認証フロー

```
┌────────────┐    ┌────────────┐    ┌────────────┐
│            │    │            │    │            │
│ クライアント │───►│ APIゲートウェイ │───►│ 認証サービス │
│            │    │            │    │            │
└────────────┘    └────────────┘    └────────────┘
       ▲                                   │
       │                                   │
       │          ┌────────────┐           │
       │          │            │           │
       └──────────│ JWTトークン  │◄──────────┘
                  │            │
                  └────────────┘
```

### 認証フローの詳細

1. **クライアント認証リクエスト**
   - ユーザーがログインフォームから認証情報を送信
   - または、OAuthプロバイダーからのコールバックを受信

2. **APIゲートウェイルーティング**
   - 認証リクエストを認証サービスに転送
   - 基本的なバリデーションと前処理を実行

3. **認証サービス処理**
   - ユーザー認証情報の検証
   - OAuthトークンの検証と交換
   - ユーザー情報の取得

4. **トークン生成**
   - JWTトークン生成（アクセストークンとリフレッシュトークン）
   - ユーザー情報とロールのエンコード
   - トークン有効期限の設定

5. **クライアントへの応答**
   - トークンとユーザー情報をクライアントに返送
   - クライアントにトークンを保存（LocalStorage/Cookie）

6. **後続リクエストの認証**
   - クライアントが各リクエストにトークンを添付
   - APIゲートウェイがトークンを検証
   - 必要に応じてロールベースのアクセス制御を適用

## 3.3 ドキュメント処理フロー

```
┌────────────┐    ┌────────────┐    ┌────────────┐
│            │    │            │    │            │
│ クライアント │───►│ドキュメント管理│───►│ Celeryワーカー│
│            │    │  サービス   │    │            │
└────────────┘    └────────────┘    └────────────┘
       ▲                │                  │
       │                ▼                  ▼
       │          ┌────────────┐    ┌────────────┐
       │          │            │    │            │
       │          │  データベース │    │  S3ストレージ │
       │          │            │    │            │
       │          └────────────┘    └────────────┘
       │                                  │
       │                                  ▼
       │                           ┌────────────┐
       │                           │            │
       │                           │ ベクトルDB   │
       │                           │            │
       │                           └────────────┘
       │                                  │
       └──────────────────────────────────┘
```

### ドキュメント処理フローの詳細

1. **ドキュメントアップロード**
   - クライアントがドキュメントをアップロード
   - ドキュメント管理サービスが基本的なメタデータを抽出
   - ドキュメントメタデータをデータベースに保存
   - 原本ドキュメントをS3に保存

2. **処理タスクのキュー**
   - 非同期処理タスクをCeleryキューに追加
   - 処理ステータスを「待機中」に設定

3. **テキスト抽出と前処理**
   - Celeryワーカーがドキュメントを取得
   - ドキュメント形式に適したパーサーでテキスト抽出
   - テキストクリーニングと正規化
   - ステータスを「処理中」に更新

4. **チャンク分割**
   - テキストを意味のあるチャンクに分割
   - チャンクごとにメタデータを付与
   - 処理済みテキストをS3に保存（オプション）

5. **ベクトル化とインデックス登録**
   - チャンクごとに埋め込みベクトル生成
   - ベクトルとメタデータをElasticsearchに登録
   - インデックス更新と最適化

6. **処理完了通知**
   - 処理ステータスを「完了」に更新
   - 処理結果をデータベースに保存
   - WebSocketを通じてクライアントに通知

## 3.4 検索・生成フロー

```
┌────────────┐    ┌────────────┐    ┌────────────┐
│            │    │            │    │            │
│ クライアント │───►│ APIゲートウェイ │───►│ RAGエンジン  │
│            │    │            │    │            │
└────────────┘    └────────────┘    └────────────┘
       ▲                                   │
       │                                   │
       │                                   ▼
       │                           ┌────────────┐    ┌────────────┐
       │                           │            │    │            │
       │                           │ベクトルDB    │──►│  LLMサービス │
       │                           │            │    │            │
       │                           └────────────┘    └────────────┘
       │                                                    │
       └────────────────────────────────────────────────────┘
```

### 検索・生成フローの詳細

1. **ユーザークエリ受信**
   - クライアントがチャットメッセージを送信
   - APIゲートウェイがリクエストをRAGエンジンに転送

2. **クエリ処理**
   - クエリの前処理と分析
   - 検索対象コレクションの特定
   - クエリのベクトル埋め込み生成

3. **ベクトル検索**
   - クエリベクトルを使用してElasticsearchで類似検索
   - 関連性スコアに基づいて結果をランク付け
   - フィルタと制約を適用（日付、カテゴリなど）

4. **キーワード検索補完（オプション）**
   - キーワードベースの検索を実行
   - ベクトル検索結果と組み合わせ
   - ハイブリッドランキングの適用

5. **コンテキスト構築**
   - 検索結果からLLM用のコンテキスト構築
   - トークン制限に基づくチャンク選択
   - 会話履歴の統合

6. **プロンプト生成**
   - 適切なプロンプトテンプレートの選択
   - 変数置換とプロンプト構成
   - システム指示の追加

7. **LLM呼び出し**
   - LLMサービスを通じてLLMプロバイダーに要求
   - ストリーミングレスポンスの開始
   - トークン使用量の追跡

8. **クライアントレスポンス**
   - LLMからのストリーミングレスポンスをクライアントに転送
   - 引用ソースと参照情報の追加
   - 会話履歴の更新

9. **フィードバックとログ**
   - 会話データのログ記録
   - 引用チャンクの正確性追跡
   - 将来の検索結果最適化のためのフィードバック収集
